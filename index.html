<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Or√ßamento</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f5f5f5;
      padding: 10px;
    }

    .orcamento {
      background: white;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1, h3, p {
      text-align: center;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }

    .logo-car {
      width: 200px;
      margin: auto;
      margin-bottom: 5px; /* diminui margem para logo mais perto do texto */
    }

    .logo {
      height: 100px;
      display: block;
      margin: 0 auto 0; /* remove margem inferior extra */
    }

    .info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .datatime {
      margin-top: 10px;
      font-size: 0.95rem;
      text-align: center;
    }

    .table-wrapper {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }

    table {
      width: 100%;
      max-width: 800px;
      border-collapse: collapse;
    }

    table th, table td {
      border: 1px solid #ccc;
      background-color: #27ae60;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    .total {
      font-weight: bold;
      text-align: right;
      font-size: 1.1rem;
      margin-top: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .controls button {
      padding: 10px 15px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      .info {
        grid-template-columns: 1fr;
      }

      table th, table td {
        font-size: 0.8rem;
        padding: 6px;
      }

      .controls button {
        width: 100%;
      }
    }

    #preview {
      text-align: center;
      margin-top: 30px;
    }

    #previewImage {
      max-width: 600px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 20px auto;
    }
  </style>
</head>
<body>

<div class="orcamento" id="orcamento">
  <div class="logo-car">
    <img src="./img/imgg.avif" alt="EliteCar Logo" class="logo">
  </div>

  <h1>Elite Car</h1>
  <p>Lanternagem e Pintura</p>
  <h3>Or√ßamento</h3>

  <div class="info">
    <input type="text" placeholder="Nome da Cliente" id="cliente">
    <input type="text" placeholder="CNPJ / CPF" id="cnpj">
    <input type="text" placeholder="Endere√ßo" id="endereco">
    <input type="text" placeholder="Telefone / WhatsApp" id="telefone">
  </div>

  <div class="datatime">
    <p>Data: <span id="data"></span></p>
    <p>Hora: <span id="hora"></span></p>
    <p><strong>Este or√ßamento √© v√°lido por 7 dias.</strong></p>
  </div>

  <div class="table-wrapper">
    <table id="itens">
      <thead>
        <tr>
          <th>Qtd</th>
          <th>Descri√ß√£o</th>
          <th>Valor Unit√°rio</th>
          <th>Total</th>
          <th class="botao-coluna">A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="listaItens"></tbody>
    </table>
  </div>

  <div class="controls">
    <button onclick="adicionarItem()">Adicionar Item</button>
  </div>

  <div id="obsWrapper">
    <p><strong>Observa√ß√µes:</strong></p>
    <textarea id="obs" placeholder="Observa√ß√µes..." rows="4"></textarea>
  </div>

  <div id="assinaturaWrapper">
    <input type="text" id="assinatura" placeholder="Assinatura do Respons√°vel">
  </div>

  <div class="controls" id="controles">
    <button onclick="gerarOrcamento()">Gerar Pr√©-visualiza√ß√£o</button>
  </div>
</div>

<!-- √Årea de visualiza√ß√£o -->
<div id="preview" class="hidden">
  <h3>Pr√©-visualiza√ß√£o do Or√ßamento</h3>
  <img id="previewImage" src="" alt="Pr√©via do or√ßamento gerado">
  <div class="controls">
    <button onclick="baixarImagem()">Confirmar e Baixar JPG</button>
    <button onclick="voltarEdicao()">Editar Novamente</button>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  function atualizarDataHora() {
    const agora = new Date();
    document.getElementById('data').innerText = agora.toLocaleDateString();
    document.getElementById('hora').innerText = agora.toLocaleTimeString();
  }

  function adicionarItem() {
    const tbody = document.getElementById('listaItens');
    const linha = document.createElement('tr');

    linha.innerHTML = `
      <td><input type="number" value="1" min="1" onchange="calcularTotal()"></td>
      <td><input type="text" placeholder="Descri√ß√£o"></td>
      <td><input type="number" value="0" min="0" onchange="calcularTotal()"></td>
      <td>R$ 0.00</td>
      <td class="botao-coluna"><button onclick="this.closest('tr').remove(); calcularTotal();">üóëÔ∏è</button></td>
    `;

    tbody.appendChild(linha);
    calcularTotal();
  }

  function calcularTotal() {
    let total = 0;
    const linhas = document.querySelectorAll('#listaItens tr');
    linhas.forEach(linha => {
      const qtd = parseFloat(linha.children[0].querySelector('input').value) || 0;
      const valor = parseFloat(linha.children[2].querySelector('input').value) || 0;
      const subtotal = qtd * valor;
      linha.children[3].innerText = 'R$ ' + subtotal.toFixed(2);
      total += subtotal;
    });

    let valorTotalEl = document.getElementById('valorTotal');
    if (valorTotalEl) {
      valorTotalEl.innerText = total.toFixed(2);
    }
  }

  function validarCampos() {
    const campos = ['cliente', 'cnpj', 'endereco', 'telefone', 'assinatura'];
    for (const id of campos) {
      const el = document.getElementById(id);
      if (!el.value.trim()) {
        alert(`Preencha o campo: ${el.placeholder}`);
        el.focus();
        return false;
      }
    }

    const linhas = document.querySelectorAll('#listaItens tr');
    if (linhas.length === 0) {
      alert('Adicione pelo menos um item ao or√ßamento.');
      return false;
    }

    for (const linha of linhas) {
      const qtd = linha.children[0].querySelector('input').value;
      const desc = linha.children[1].querySelector('input').value;
      const val = linha.children[2].querySelector('input').value;

      if (!qtd || !desc.trim() || !val) {
        alert('Todos os campos dos itens devem estar preenchidos.');
        return false;
      }
    }

    return true;
  }

  async function gerarOrcamento() {
    if (!validarCampos()) return;

    // Esconde controles para preview limpo
    document.getElementById('controles').classList.add('hidden');
    document.querySelectorAll('.botao-coluna, .botao-coluna button').forEach(el => el.classList.add('hidden'));
    document.querySelector('.controls button[onclick="adicionarItem()"]').classList.add('hidden');

    // Substitui inputs da tabela por texto para renderizar imagem limpa
    const inputsTabela = document.querySelectorAll('#listaItens input');
    inputsTabela.forEach(input => {
      const td = input.parentElement;
      td.innerHTML = input.value;
    });

    // Campo assinatura vira texto
    const assinatura = document.getElementById('assinatura').value;
    const assinaturaWrapper = document.getElementById('assinaturaWrapper');
    assinaturaWrapper.innerHTML = `<p><strong>Assinatura:</strong> ${assinatura}</p>`;

    // Gera canvas para preview com escala menor para melhor visualiza√ß√£o
    const canvas = await html2canvas(document.querySelector("#orcamento"), { scale: 0.7 });

    // Restaura tabela e assinatura para inputs para continuar edi√ß√£o
    const tbody = document.getElementById('listaItens');
    const linhas = tbody.querySelectorAll('tr');
    linhas.forEach(linha => {
      const qtd = linha.children[0].innerText;
      const desc = linha.children[1].innerText;
      const val = linha.children[2].innerText;

      linha.children[0].innerHTML = `<input type="number" value="${qtd}" min="1" onchange="calcularTotal()">`;
      linha.children[1].innerHTML = `<input type="text" placeholder="Descri√ß√£o" value="${desc}">`;
      linha.children[2].innerHTML = `<input type="number" value="${val}" min="0" onchange="calcularTotal()">`;
      calcularTotal();
    });

    assinaturaWrapper.innerHTML = `<input type="text" id="assinatura" placeholder="Assinatura do Respons√°vel" value="${assinatura}">`;

    // Exibe preview da imagem gerada
    document.getElementById('previewImage').src = canvas.toDataURL("image/jpeg");

    // Alterna visibilidade para mostrar preview e esconder form
    document.getElementById('orcamento').classList.add('hidden');
    document.getElementById('preview').classList.remove('hidden');
  }

  function baixarImagem() {
    const img = document.getElementById('previewImage');
    const link = document.createElement('a');
    link.download = 'orcamento.jpg';
    link.href = img.src;
    link.click();
  }

  function voltarEdicao() {
    // Volta para edi√ß√£o mostrando form e controles
    document.getElementById('orcamento').classList.remove('hidden');
    document.getElementById('preview').classList.add('hidden');

    // Restaura controles e bot√µes
    document.getElementById('controles').classList.remove('hidden');
    document.querySelectorAll('.botao-coluna, .botao-coluna button').forEach(el => el.classList.remove('hidden'));
    document.querySelector('.controls button[onclick="adicionarItem()"]').classList.remove('hidden');

    // Restaura campo assinatura para input (se foi alterado)
    let assinaturaWrapper = document.getElementById('assinaturaWrapper');
    if (!document.getElementById('assinatura')) {
      assinaturaWrapper.innerHTML = `<input type="text" id="assinatura" placeholder="Assinatura do Respons√°vel">`;
    }
  }

  atualizarDataHora();
</script>

</body>
</html>
