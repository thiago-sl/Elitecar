<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Or√ßamento</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f5f5f5;
      padding: 10px;
    }

    .orcamento {
      background: white;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1, h3, p {
      text-align: center;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }

    .logo-car {
      width: 200px;
      margin: auto;
      margin-bottom: 5px;
    }

    .logo {
      height: 100px;
      display: block;
      margin: 0 auto 0;
    }

    .info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .info.cliente {
      grid-template-columns: repeat(2, 1fr);
    }

    .info.veiculo {
      grid-template-columns: repeat(3, 1fr);
    }

    .datatime {
      margin-top: 10px;
      font-size: 0.95rem;
      text-align: center;
    }

    .table-wrapper {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }

    table {
      width: 100%;
      max-width: 800px;
      border-collapse: collapse;
    }

    table th, table td {
      border: 1px solid #ccc;
      background-color: #27ae60;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    .total {
      font-weight: bold;
      text-align: right;
      font-size: 1.1rem;
      margin-top: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .controls button {
      padding: 10px 15px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      .info.cliente, .info.veiculo {
        grid-template-columns: 1fr;
      }

      table th, table td {
        font-size: 0.8rem;
        padding: 6px;
      }

      .controls button {
        width: 100%;
      }
    }

    #preview {
      text-align: center;
      margin-top: 30px;
    }

    #previewImage {
      max-width: 600px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 20px auto;
    }
    .download-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>

<div class="orcamento" id="orcamento">
  <div class="logo-car">
    <img src="./img/imgg.avif" alt="EliteCar Logo" class="logo">
  </div>

  <h1>Elite Car</h1>
  <p>Lanternagem e Pintura</p>
  <h3>Or√ßamento</h3>

  <!-- Dados do Cliente -->
  <div class="info cliente">
    <input type="text" placeholder="Nome da Cliente" id="cliente">
    <input type="text" placeholder="CNPJ / CPF" id="cnpj">
    <input type="text" placeholder="Endere√ßo" id="endereco">
    <input type="text" placeholder="Telefone / WhatsApp" id="telefone">
  </div>
   <h1>Dados do Veiculo</h1>
  <!-- Dados do Ve√≠culo -->
  <div class="info veiculo">
   
    <input type="text" placeholder="Modelo" id="modelo">
    <input type="text" placeholder="Placa" id="placa">
     <input type="text" placeholder="Cor" id="cor">
  </div>

  <div class="datatime">
    <p>Data: <span id="data"></span></p>
    <p>Hora: <span id="hora"></span></p>
    <p><strong>Este or√ßamento √© v√°lido por 7 dias.</strong></p>
  </div>

  <div class="table-wrapper">
    <table id="itens">
      <thead>
        <tr>
          <th>Qtd</th>
          <th>Descri√ß√£o</th>
          <th>Valor Unit√°rio</th>
          <th>Total</th>
          <th class="botao-coluna">A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="listaItens"></tbody>
    </table>
  </div>

  <div class="controls">
    <button onclick="adicionarItem()">Adicionar Item</button>
  </div>

  <div id="obsWrapper">
    <p><strong>Observa√ß√µes:</strong></p>
    <textarea id="obs" placeholder="Observa√ß√µes..." rows="4"></textarea>
  </div>

  <div id="assinaturaWrapper">
    <input type="text" id="assinatura" placeholder="Assinatura do Respons√°vel">
  </div>

  <div class="controls" id="controles">
    <button onclick="gerarOrcamento()">Gerar Pr√©-visualiza√ß√£o</button>
  </div>
</div>

<div class="controls download-buttons">
  <button onclick="baixarImagem()">Confirmar e Baixar JPG</button>
  <button onclick="compartilharOrcamento()">Compartilhar</button>
  <button onclick="voltarEdicao()">Editar Novamente</button>
</div>

<!-- √Årea de visualiza√ß√£o -->
<div id="preview" class="hidden">
  <h3>Pr√©-visualiza√ß√£o do Or√ßamento</h3>
  <img id="previewImage" src="" alt="Pr√©via do or√ßamento gerado">
  <div class="controls">
    <button onclick="baixarImagem()">Confirmar e Baixar JPG</button>
    <button onclick="compartilharOrcamento()">Compartilhar</button>
    <button onclick="voltarEdicao()">Editar Novamente</button>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  function atualizarDataHora() {
    const agora = new Date();
    document.getElementById('data').innerText = agora.toLocaleDateString();
    document.getElementById('hora').innerText = agora.toLocaleTimeString();
  }

  function adicionarItem() {
    const tbody = document.getElementById('listaItens');
    const linha = document.createElement('tr');

    linha.innerHTML = `
      <td><input type="number" value="1" min="1" onchange="calcularTotal()"></td>
      <td><input type="text" placeholder="Descri√ß√£o"></td>
      <td><input type="number" value="0" min="0" onchange="calcularTotal()"></td>
      <td>R$ 0.00</td>
      <td class="botao-coluna"><button onclick="this.closest('tr').remove(); calcularTotal();">üóëÔ∏è</button></td>
    `;

    tbody.appendChild(linha);
    calcularTotal();
  }

  function calcularTotal() {
    let total = 0;
    const linhas = document.querySelectorAll('#listaItens tr');
    linhas.forEach(linha => {
      const qtd = parseFloat(linha.children[0].querySelector('input').value) || 0;
      const valor = parseFloat(linha.children[2].querySelector('input').value) || 0;
      const subtotal = qtd * valor;
      linha.children[3].innerText = 'R$ ' + subtotal.toFixed(2);
      total += subtotal;
    });

    let valorTotalEl = document.getElementById('valorTotal');
    if (valorTotalEl) {
      valorTotalEl.innerText = total.toFixed(2);
    }
  }

  async function gerarOrcamento() {
    if (!validarCampos()) return;

    document.getElementById('controles').classList.add('hidden');
    document.querySelectorAll('.botao-coluna, .botao-coluna button').forEach(el => el.classList.add('hidden'));
    document.querySelector('.controls button[onclick="adicionarItem()"]').classList.add('hidden');

    const inputsTabela = document.querySelectorAll('#listaItens input');
    inputsTabela.forEach(input => input.setAttribute('readonly', 'readonly'));

    document.querySelectorAll('input, textarea').forEach(input => input.setAttribute('readonly', 'readonly'));

    atualizarDataHora();

    const orcamentoDiv = document.getElementById('orcamento');
    const preview = document.getElementById('preview');
    preview.classList.remove('hidden');

    try {
      const canvas = await html2canvas(orcamentoDiv, { scale: 2 });
      const dataURL = canvas.toDataURL('image/jpeg', 0.9);
      document.getElementById('previewImage').src = dataURL;
    } catch (error) {
      alert('Erro ao gerar imagem do or√ßamento: ' + error);
      voltarEdicao();
    }
  }

  function validarCampos() {
    // Exemplo b√°sico: checar se o nome do cliente e ao menos um item est√£o preenchidos
    if (!document.getElementById('cliente').value.trim()) {
      alert('Por favor, preencha o nome da cliente.');
      return false;
    }
    if (document.querySelectorAll('#listaItens tr').length === 0) {
      alert('Adicione pelo menos um item.');
      return false;
    }
    return true;
  }

  function voltarEdicao() {
    document.getElementById('preview').classList.add('hidden');
    document.getElementById('controles').classList.remove('hidden');
    document.querySelectorAll('.botao-coluna, .botao-coluna button').forEach(el => el.classList.remove('hidden'));
    document.querySelector('.controls button[onclick="adicionarItem()"]').classList.remove('hidden');

    document.querySelectorAll('#listaItens input').forEach(input => input.removeAttribute('readonly'));
    document.querySelectorAll('input, textarea').forEach(input => input.removeAttribute('readonly'));
  }

  function baixarImagem() {
    const img = document.getElementById('previewImage');
    if (!img.src) {
      alert('Gere a pr√©-visualiza√ß√£o antes de baixar.');
      return;
    }
    const a = document.createElement('a');
    a.href = img.src;
    a.download = 'orcamento.jpg';
    a.click();
  }

  async function compartilharOrcamento() {
    const img = document.getElementById('previewImage');

    try {
      const response = await fetch(img.src);
      const blob = await response.blob();
      const file = new File([blob], 'orcamento.jpg', { type: 'image/jpeg' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: 'Or√ßamento Elite Car',
          text: 'Confira o or√ßamento gerado pela Elite Car.',
        });
      } else if (navigator.share) {
        await navigator.share({
          title: 'Or√ßamento Elite Car',
          text: 'Confira o or√ßamento gerado pela Elite Car.',
          url: img.src,
        });
      } else {
        alert('Este navegador n√£o suporta compartilhamento.');
      }
    } catch (err) {
      alert('Erro ao compartilhar: ' + err.message);
    }
  }

  // Atualiza data e hora ao carregar
  atualizarDataHora();

  // Adiciona um item inicial para facilitar
  adicionarItem();

  // Esconde bot√£o compartilhar se n√£o suportar
  document.addEventListener("DOMContentLoaded", () => {
    const compartilharBtn = document.querySelector('button[onclick="compartilharOrcamento()"]');

    // Teste r√°pido para evitar exibir bot√£o onde n√£o funciona
    if (
      !navigator.share ||
      (!navigator.canShare?.({ files: [new File([""], "teste.jpg", { type: "image/jpeg" })] }) &&
      !navigator.canShare?.({ url: "https://exemplo.com" }))
    ) {
      compartilharBtn.style.display = 'none';
    }
  });
</script>

</body>
</html>
